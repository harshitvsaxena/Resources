<a id="top"></a>

# NodeJS

[Main Page](README.md)

## NodeJS and MySQL

To communicate node.js with MySQL server we need to install mysql module. For this, switch to the directory where you are saving the node modules using `cd`, now:

```sh
$ npm install mysql --save
```

Now in your `server.js` file that is the server file write this:

```javascript
var mysql = require("mysql");

// First you need to create a connection to the db
var con = mysql.createConnection({
  host: "localhost",
  user: "root",
  password: "password",
  database: "databaseName"
});

con.connect(function(err){
  if(err){
    console.log('Error connecting to Db');
    return;
  }
  console.log('Connection established');
});

con.query('SELECT * FROM tableName',function(err,rows){
  if(err) throw err;
  console.log('Data received from Db:\n');
  console.log(rows);
});

con.end(function(err) {
  // The connection is terminated gracefully
  // Ensures all previously enqueued queries are still
  // before sending a COM_QUIT packet to the MySQL server.
});
```

Now if you go to terminal and run the node server like this:

```sh
$ node server.js
```

You will be able to get the output in the terminal.

Now to get the output as json on the front end, that is in a html file we need to have these node modules installed, so go ahead and run these commands

```sh
$ npm install express --save
$ npm install http --save
$ npm install socket.io --save
```

Now modify the above `server.js` file like this:

```javascript
var express = require('express');
var http = require('http');
var io = require('socket.io');
var mysql = require("mysql");

var app = express();

/* Specifying the public folder of the server to make the html accesible using the static middleware */
app.use(express.static('../'));

/* Server listens on the port 8124 */
var server = http.createServer(app).listen(8124);

/*initializing the websockets communication , server instance has to be sent as the argument */
io = io.listen(server);

io.sockets.on("connection",function(socket) {

  /* First you need to create a connection to the db */
  var con = mysql.createConnection({
    host: "localhost",
    user: "root",
    password: "password",
    database: "databaseName"
  });

  con.connect(function(err){
    if(err){
      console.log('Error connecting to Db');
      return;
    }
    console.log('Connection established');
  });

  con.query('SELECT * FROM tableName', function(err,rows){
    if(err) throw err;
    console.log('Data received from Db\n');
    //console.log(rows);
    socket.send(JSON.stringify(rows, null, 2));
  });

  con.end(function(err) {
    // The connection is terminated gracefully
    // Ensures all previously enqueued queries are still
    // before sending a COM_QUIT packet to the MySQL server.
  });

});
```

Now we need to create a front end for this,

According to the file above, your directory setup should be like this:

```
localhost(/var/www/html)
|--index.html
|--js
|   |--client.js
|--server
    |--node_modules
    |--package.json
    |--server.js
```

Now lets create html(`index.html`) file for our server to serve the client:

```html
<!DOCTYPE html>
<html>
  <head>
    <title>NodeJS And MySQL Example</title>
  </head>
  <body>
    <h1>Showing data here:</h1>
    <div id="content">
      <ul></ul>
    </div>
    <!--The below library(/socket.io/socket.io.js) will be generated by socket.io module of server -->
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="/js/client.js" type="text/JavaScript"></script>
  </body>
</html>
```

Let's see how our `client.js` should look like:

```javascript
var socket = io.connect("/");

socket.on('connect', function() {
  console.log("server connection established..");
});

/*Initializing the connection with the server via websockets */
socket.on("message", function(message){
  /*
      When server sends data to the client it will trigger "message" event on the client side , by
      using socket.on("message") , one can listen for the message event and associate a callback to
      be executed. The Callback function gets the data sent from the server.
  */
  /* First time content fetching */
  console.log("Message from the server arrived")
  message = JSON.parse(message);
  console.log(message);
  var x = 0;
  while(x < message.length) {
    $('#content ul').append('<li>id: ' + message[x]['userid'] + '<br>Name: ' + message[x]['name'] + '<br>Email: ' + message[x]['email'] + '</li>');
    x++;
  }
});

socket.on('disconnect',function() {
  console.log("socket Disconnected..");
});
```

Before running this have a mysql table having structure as shown below:

| userid | name           | email               |
|--------|----------------|---------------------|
| 1      | Harshit Saxena | me@harshitsaxena.in |
| 2      | Srishti        | srishti@idk.com     |
| 3      | someName       | someName@mail.com   |

Now go ahead open a browser and hit `http://localhost:8124`.

You should be able to see the above table in your browser as a list. For checking the json object received open `inspect element` in your browser and see `console log`.

---

Resource: https://www.sitepoint.com/using-node-mysql-javascript-client/

[Main Page](README.md) | [Top](#top)

---

## The End
